---
title: 'HelpAge International: 2011 India NSS Analysis'
author: "Stewart Kerr & Rick Griffin"
date: "`r Sys.Date()`"
output:
  pdf_document:
    fig_caption: yes
header-includes:
- \usepackage{caption}
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage{setspace}
- \doublespacing
---

\captionsetup[table]{labelformat=empty}
\captionsetup[figure]{labelformat=empty}

```{r load_data, echo = FALSE, error = FALSE, warning=FALSE, include = FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=7, echo=FALSE, warning=FALSE, message=FALSE, fig.pos = 'h')

# require(ggplot2)
# require(GGally)
# require(gridExtra)
# require(tableone)
# require(furniture)
# require(lindia)
# require(broom) 
# require(knitr) 
require(kableExtra)
# require(ggfortify)
# require(glmnet)
# require(plotmo)
# require(scales)
# require(JM)
# require(WR)
# require(stringr)
require(dplyr)
# require(tidyr)
# require(MuMIn)
# require(RColorBrewer)



# Load the individuals dataset
individuals = read.csv("data/processed/2011_India_LFS_individuals.csv")

# Load bootstrap results
results = read.csv("data/final/2011_India_LFS_bootstrap_results.csv")

```

# 1. Summary

# 2. Introduction
HelpAge International wants to challenge established norms for statistical reporting on older persons by proving that data disaggregation to a lower, more granular level is possible and statistically robust. Nongranular statistics reinforces an oversimplified picture of inequalities and the inadequate data itself becomes a barrier to the inclusion of at-risk and marginalized groups in policy and program responses. 

To serve this goal, we analyzed data from the employment and unemployment surveys included in the 2011 India National Sample Survey (NSS)  to determine the lowest level of disaggregation that was possible while maintaining statistical robust estimates of average wage. The employment and unemployment surveys of the NSS aim to get estimates of various employment characteristics at the national and state level. In addition to employment related variables, individual characteristics such as region, age, sex, industry, education, and others are collected by the survey. In accordance with HelpAge's statement of work, we focused how earnings of employees varied by an individual's age, sex, employment industry, and region (urban/rural). Disability status was only collected in relationship to employment (i.e. unable to work due to disability) and was not available to analyze in relation to average earnings.

In our analysis, we sought to answer three specific research questions related to data disaggregation:

1. What is the most granular level of disaggregation of age, sex, and employment industry? What are the most appropriate age bands (i.e. 5 year groupings or 10 year groupings) and upper age cohort (i.e. 80+, 85+, etc)? How do results differ going from broader to more granular disaggregation?
2. What is the most granular level of disaggregation of age, sex, and employment industry when we also include geographic location (urban/rural)?
3. Based on these results, what general recommendations or considerations can be made on data disaggregation for similar surveys?

# 3. Materials and Methods
## Data Collection
The 2011 India NSS used a stratified multi-stage design. First villages in rural communities were selected by probability proportional to size with replacement while blocks in urban areas were selected by simple random sampling without replacement. An equal number of villages and blocks were selected. Next, if the village or block contained more than 1200 people, it was divided into subgroups containing roughly the same amount of people. Then, households within each subgroup were stratified into 3 groups according to to measures of wealth. Lastly, households from each strata were selected by simple random sampling without replacement and all individuals within the household were surveyed. Samplings weights were calculated and provided for each individual by the India Ministry of Statistics & Programme Implementation.

We extracted the raw survey data in .sav (SPSS) format from the file provided by HelpAge using the required Nesstar Explorer software. For our analysis, we needed to extract the data files `Block_4_Demographic particulars of household members` and `Block 5_3_Time disposition during the week ended on `. This data was then loaded into R using the `haven` package and processed using the `tidyverse` set of R packages.

## Data Processing
First, in order to join demographic data in the "Block 4" (B4) dataset to employment data for the past week in the "Block 5_3" (B53) dataset, we had to create a unique ID. This was accomplished by concatenating the following variables for each dataset:
* `FSU_Serial_No`, `Stratum`, `Sub_Stratum_No`, `Hamlet_Group_Sub_Block_No`, `Second_Stage_Stratum_No`, `Sample_Hhld_No`, and `Person_Serial_No`

Then, before joining B4 and B53, the following variables were processed or created from the B53 dataset:
* `employment_status` - Takes either "employed", "unemployed" or "not in labor force" depending on the value of `current_weekly_activity_status` 
* `weekly_earnings` - An individual can have multiple entries in the B53 dataset if they performed multiple jobs during the week. Thus, for each person, we get their total weekly earnings by summing their earnings across the last 7 days.
* `industry` - There are many industries reported in the `current_weekly_activity_NIC_2008` variable. We collapsed the industries into 4 groups based on sample size considerations: "farming, forestry, or fishing", "manufacturing", "construction", or "other".

After creating these variables, we joined the B4 and B53 datasets as our "analysis dataset." As we are primarily interested in the average earnings of different groups, we focused only on employed individuals. However, there are many employed people in the dataset that did not report any earnings in the previous 7 days. Nevertheless, **we chose to keep those individuals in our analysis dataset.** Table 1 presents the counts of the people included in our analysis dataset.

```{r table1, echo = FALSE}
#Separate by employment status
employed = filter(individuals, employment_status == "Employed")
unemployed = filter(individuals, employment_status == "Unemployed")
nlf = filter(individuals, employment_status == "Not in labor force")

# Separate by sex
employed_m = filter(employed, sex == "Male")
employed_f = filter(employed, sex == "Female")
unemployed_m = filter(unemployed, sex == "Male")
unemployed_f = filter(unemployed, sex == "Female")
nlf_m = filter(nlf, sex == "Male")
nlf_f = filter(nlf, sex == "Female")

  
#Get the columns for table 1
t1_cols = c("", rep(c("Male", "Female"), 3), "Overall")
t1_rows = c("Under 60", "60-64", "65-69", "70-74", "75-79", "80+", "Farming, forestry, or fishing", "Manufacturing", "Construction", "Other", "Urban", "Rural", "Total")
t1_count = function(df){
  out = c(sum(df$age_group5 == "Under 60"), sum(df$age_group5 == "60-64"), sum(df$age_group5 == "65-69"), sum(df$age_group5 == "70-74"), sum(df$age_group5 == "75-79"), sum(df$age_group5 == "80+"), sum(df$industry == "Farming, forestry, or fishing"), sum(df$industry == "Manufacturing"), sum(df$industry == "Construction"), sum(df$industry == "Other"), sum(df$urban == 1), sum(df$urban == 0), nrow(df))
  return(out)
}
t1_counts = cbind(t1_count(employed_m), t1_count(employed_f), t1_count(unemployed_m), t1_count(unemployed_f), t1_count(nlf_m), t1_count(nlf_f), t1_count(individuals))

#Build the table
t1_raw = cbind(t1_rows, t1_counts)

#Print the table
kable(t1_raw,
      caption = "Table 1. Counts of people in various groupings of the 2011 India NSS survey.",
      digits = 2,
      row.names = FALSE,
      col.names = t1_cols,
      align = 'c',
      booktabs = T,
      escape = TRUE,
      linesep = "") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  column_spec(ncol(t1_raw), bold = TRUE) %>%
  add_header_above(c(" " = 1, "Employed" = 2, "Unemployed" = 2, "Not in labor force" = 2, " " = 1))

```

## Statistical Analysis and Results
For each grouping of employed people, we are interested in the average weekly earnings. The average earnings were calculated using the survey weights, which indicate how many individuals in India's population that a sampled person represents. That is, for each group we performed the calculation:

$$
\frac{\sum_i w_iY_i}{\sum_iw_i}
$$
where $w_i$ is the weight and $Y_i$ is the weekly earnings for individual i within the grouping. Then, the standard error (SE) of these weighted estimates was calculated using a simple bootstrap method^1^. A bootstrap method was chosen because the survey design is highly complex and calculating standard errors while accounting for this design would be difficult and complicated. The cost of using bootstrap to estimate standard errors instead of incorporating the survey design causes our standard errors to be slightly larger, however, we compared our bootstrap standard errors with a simple random sampling variance multiplied by a cluster sampling design effect to verify that the bootstrap variances magnitudes were reasonable. 

For each group identified below, 1000 independent bootstrap replicates each of the size of the group were selected by simple random sampling with replacement. Thus, each bootstrap replicate has the same sample size as the group but some sample persons might be selected more than once and others not at all in each replicate. For each replicate, the weighted average earnings were calculated as described above. Then, the sample variance over these 1000 weighted estimates was calculated and the square root of the variance is the standard error. For each grouping, 95% confidence intervals for the estimate of weekly earnings were calculated using this formula:

$$
\bar{Y} \pm 1.96\times SE(\bar{Y})
$$

where $\bar{Y}$ is the weighted estimate from the original sample and $SE(\bar{Y})$ is the standard error of the estimate calculated using the bootstrap procedure.

To produce accurate estimates that are statistically robust, we suggest including at least 150 sampled persons in the group. With this consideration, we first considered the most granular level of disaggregation: stratification by 5 year age groups sex, industry, and geographic location (urban/rural) across the board. In most cases, our sample size was not large enough to include the secondary level of disaggregation of urban/rural. Specifically, we were only able to include urban/rural for employed person's under the age of 60 and men aged 60-64. Additionally, as the count of employed people decreased at older ages, we had to collapse industry categories in order to maintain a sample size that was close to or greater than 150. At our oldest age groups, we had to drop stratification by industry entirely. After collapsing these levels of disaggregation, we arrived at the most granular level of disaggregation that we can recommend as being statistically robust for this particular survey. The results of this analysis and all subsequent analysis are shown in table 2 in the appendix.

Next, we used the same stratification categories with 10 year age groupings instead of 5 year age groupings to assess the difference of results using different age groupings. 

Lastly, we dropped the secondary level of disaggregation, geographic location, entirely to examine how different the results are whenever less disaggregation is performed. As we included urban/rural only for people younger than 60 and men aged 60-64 in our primary analysis, we can only compare results for a small subset of groupings. 

Now, we provide instructions and an example on the comparison of any two particular groups. For any two groups, if the 95% confidence intervals do not overlap then it is clear that the average earnings in the two groups are significantly different. If the confidence intervals do overlap, then a simple 5% error hypothesis test can be used to test the null hypothesis that the two groups have the same average wage. The detectable difference between two estimates is 1.96 times the standard error of the difference between the two estimates. The standard error of the difference is calculated as:

$$
\sqrt{SE_1^2 + SE_2^2}
$$

where $SE_1$ is the standard error of the estimate for group 1's earnings and $SE_2$ is the standard error of the estimate for group 2's earnings. 

We illustrate this procedure for the comparison of the estimated average earnings of males age 60-64 in the manufacturing industry (group 1) and males age 60-64 in the "other" industry group (group 2). The estimated average wage for group 1 is $\sim567$ and the standard error is $\sim92$. The estimated wage for group 2 is $\sim493$ and the standard error is $\sim65$. The square root of $92^2$ plus $65^2$ is $\sqrt{92^2 + 65^2} = 112.65$, so the detectable difference is $1.96 \times 112.65 = 220.79$. Since the difference is $567- 493  = 74$, we cannot claim the true values are statistically different. 

# 4. Discussion
## Research question 1
For males and females under age 60 as well as males age 60-64, all 4 industry as well as urban/rural categories have enough sample to accurately estimate average wage of employed persons. For males 65-69 it is necessary to eliminate urban/rural but all 4 industry categories can be kept. For males age 70-74 and age 74-79 it is necessary to collapse to two industry categories while for males 80+ there are not enough employed persons to support any industry categories.

For Females age 60-64 and age 65-69 some collapsing of industry categories is necessary while females 70+ and 75+ do not have enough employed for any industry categories,


## Research question 2
Urban or rural can only be used for males and females under age 60 and males age 60-64. Other age and sex categories do not have enough employed persons for accurate estimation of average wage.

## Research question 3
Data disaggregation for other surveys depend heavily on the sample design and sample allocation. It is likely necessary to have at least 150 sample cases in any age/sex/industry or occupation/ geographic categories to define estimation groups. The survey designers need to keep this in mind. If estimates are desired for 5 year age/sex groups sufficient sample is necessary in those groups. 

# 5. Conclusion

# Appendix
```{r table2, echo = FALSE}
# Separate by sex
results_m = filter(results, grepl("Male", group))
results_f = filter(results, grepl("Female", group))

# Get data for the table
t2_data = data.frame(a = 1:50, b = 1:50, c = 1:50, d = 1:50, e = 1:50, f = 1:50)

# Build labels
t2_colnames = c("", rep(c("Count", "Estimate (95% CI)", "SE"),2))
t2_rownames = c(rep(c("Farming, forestry, or fishing", "Manufacturing", "Construction", "Other"),5), "Farming, forestry, or fishing", "Manufacturing", "Construction", "Manufacturing or construction", "Other", rep(c("Farming, forestry, or fishing", "Manufacturing", "Construction", "Other"),3), "Farming, forestry, or fishing", "Manufacturing", "Construction", "Manufacturing or construction", "Other", "Farming", "Other", "All", "Farming", "Other", "All", "All", "All")  

#Build the table
t2_raw = cbind(t2_rownames, t2_data)

#Print the table
kable(t2_raw,
      format = "latex",
      caption = "Table 2. Average weekly earnings for various groups surveyed in the 2011 India NSS survey.",
      digits = 2,
      row.names = FALSE,
      col.names = t2_colnames,
      align = 'c',
      booktabs = TRUE,
      longtable = TRUE,
      escape = TRUE,
      linesep = "") %>% 
  kable_styling(latex_options = c("hold_position", "repeat_header")) %>%
  #column_spec(c(1,3,6), width_min = "2in") %>%
  #column_spec(c(2,5), width_min = "0.5in") %>%
  #column_spec(c(4,7), width_min = "1in") %>% 
  column_spec(1, width_min = "2in") %>%
  column_spec(2:7, width_min = "1in") %>%
  add_header_above(c(" " = 1, "Male" = 3, "Female" = 3)) %>%
  pack_rows("Under 60, Urban", 1, 4) %>%
  pack_rows("Under 60, Rural", 5, 8) %>%
  pack_rows("Under 60, Urban and Rural", 9, 12) %>%
  pack_rows("60-64, Urban", 13, 16) %>%
  pack_rows("60-64, Rural", 17,20) %>%
  pack_rows("60-64, Urban and Rural", 21, 25) %>%
  pack_rows("65-69, Urban and Rural", 26, 29) %>%
  pack_rows("60-69, Urban", 30, 33) %>%
  pack_rows("60-69, Rural", 34, 37) %>%
  pack_rows("60-69, Urban and Rural", 38, 42) %>%
  pack_rows("70-74, Urban and Rural", 43, 45) %>%
  pack_rows("70+, Urban and Rural", 46, 46) %>%
  pack_rows("75-79, Urban and Rural", 47, 48) %>%
  pack_rows("75+, Urban and Rurals", 49, 49) %>%
  pack_rows("80+, Urban and Rural", 50, 50)

```

# References
1. [*Introduction to Bootstrapping in Statistics with an Example - Jim Frost*](https://statisticsbyjim.com/hypothesis-testing/bootstrapping/)
